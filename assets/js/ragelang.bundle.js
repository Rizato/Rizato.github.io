var k=(u=>(u.NUMBER="NUMBER",u.STRING="STRING",u.IDENTIFIER="IDENTIFIER",u.DRAW="DRAW",u.UPDATE="UPDATE",u.FUN="FUN",u.RETURN="RETURN",u.IF="IF",u.ELSE="ELSE",u.LOOP="LOOP",u.BREAK="BREAK",u.TRUE="TRUE",u.FALSE="FALSE",u.PROTOTYPE="PROTOTYPE",u.ENUM="ENUM",u.MATCH="MATCH",u.UNDERSCORE="UNDERSCORE",u.PLUS="PLUS",u.MINUS="MINUS",u.STAR="STAR",u.STAR_STAR="STAR_STAR",u.SLASH="SLASH",u.PERCENT="PERCENT",u.EQUAL="EQUAL",u.EQUAL_EQUAL="EQUAL_EQUAL",u.BANG="BANG",u.BANG_EQUAL="BANG_EQUAL",u.LESS="LESS",u.LESS_EQUAL="LESS_EQUAL",u.GREATER="GREATER",u.GREATER_EQUAL="GREATER_EQUAL",u.AND="AND",u.OR="OR",u.AMPERSAND_AMPERSAND="AMPERSAND_AMPERSAND",u.PIPE_PIPE="PIPE_PIPE",u.AMPERSAND="AMPERSAND",u.PIPE="PIPE",u.CARET="CARET",u.TILDE="TILDE",u.LESS_LESS="LESS_LESS",u.GREATER_GREATER="GREATER_GREATER",u.LPAREN="LPAREN",u.RPAREN="RPAREN",u.LBRACE="LBRACE",u.RBRACE="RBRACE",u.LBRACKET="LBRACKET",u.RBRACKET="RBRACKET",u.COMMA="COMMA",u.DOT="DOT",u.SEMICOLON="SEMICOLON",u.COLON="COLON",u.FAT_ARROW="FAT_ARROW",u.FOUNDATION="FOUNDATION",u.COMMENT="COMMENT",u.NEWLINE="NEWLINE",u.EOF="EOF",u))(k||{}),O={draw:"DRAW",update:"UPDATE",fun:"FUN",return:"RETURN",if:"IF",else:"ELSE",loop:"LOOP",break:"BREAK",true:"TRUE",false:"FALSE",prototype:"PROTOTYPE",enum:"ENUM",match:"MATCH",and:"AND",or:"OR"};var R=class{source;tokens=[];start=0;current=0;line=1;column=1;constructor(e){this.source=e}tokenize(){for(;!this.isAtEnd();)this.start=this.current,this.scanToken();return this.tokens.push({type:"EOF",lexeme:"",literal:null,line:this.line,column:this.column}),this.tokens}scanToken(){let e=this.advance();switch(e){case"(":this.addToken("LPAREN");break;case")":this.addToken("RPAREN");break;case"{":this.addToken("LBRACE");break;case"}":this.addToken("RBRACE");break;case"[":this.addToken("LBRACKET");break;case"]":this.addToken("RBRACKET");break;case",":this.addToken("COMMA");break;case".":this.addToken("DOT");break;case";":this.addToken("SEMICOLON");break;case":":this.addToken("COLON");break;case"+":this.addToken("PLUS");break;case"-":this.addToken("MINUS");break;case"*":this.addToken(this.match("*")?"STAR_STAR":"STAR");break;case"%":this.addToken("PERCENT");break;case"^":this.addToken("CARET");break;case"~":this.addToken("TILDE");break;case"&":this.addToken(this.match("&")?"AMPERSAND_AMPERSAND":"AMPERSAND");break;case"|":this.addToken(this.match("|")?"PIPE_PIPE":"PIPE");break;case"!":this.addToken(this.match("=")?"BANG_EQUAL":"BANG");break;case"=":this.match("=")?this.addToken("EQUAL_EQUAL"):this.match(">")?this.addToken("FAT_ARROW"):this.addToken("EQUAL");break;case"<":this.match("<")?this.addToken("LESS_LESS"):this.match("=")?this.addToken("LESS_EQUAL"):this.addToken("LESS");break;case">":this.match(">")?this.addToken("GREATER_GREATER"):this.match("=")?this.addToken("GREATER_EQUAL"):this.addToken("GREATER");break;case"/":this.match("/")?this.lineComment():this.addToken("SLASH");break;case"#":this.foundation();break;case" ":case"\r":case"	":break;case`
`:this.line++,this.column=1;break;case'"':this.string();break;default:this.isDigit(e)?this.number():this.isAlpha(e)&&this.identifier();break}}lineComment(){let e=this.column-2;for(;this.peek()!==`
`&&!this.isAtEnd();)this.advance();this.tokens.push({type:"COMMENT",lexeme:this.source.substring(this.start,this.current),literal:null,line:this.line,column:e})}foundation(){let e=this.column-1;this.tokens.push({type:"FOUNDATION",lexeme:"#",literal:null,line:this.line,column:e})}string(){let e=this.column-1;for(;this.peek()!=='"'&&!this.isAtEnd();)this.peek()===`
`&&(this.line++,this.column=1),this.advance();if(this.isAtEnd())throw new Error(`Unterminated string at line ${this.line}`);this.advance();let t=this.source.substring(this.start+1,this.current-1);this.tokens.push({type:"STRING",lexeme:this.source.substring(this.start,this.current),literal:t,line:this.line,column:e})}number(){let e=this.column-1,t=this.source[this.start];if(t==="0"&&(this.peek()==="x"||this.peek()==="X")){for(this.advance();this.isHexDigit(this.peek());)this.advance();let s=this.source.substring(this.start,this.current);this.tokens.push({type:"NUMBER",lexeme:s,literal:parseInt(s,16),line:this.line,column:e});return}if(t==="0"&&(this.peek()==="b"||this.peek()==="B")){for(this.advance();this.peek()==="0"||this.peek()==="1";)this.advance();let s=this.source.substring(this.start,this.current);this.tokens.push({type:"NUMBER",lexeme:s,literal:parseInt(s.slice(2),2),line:this.line,column:e});return}for(;this.isDigit(this.peek());)this.advance();if(this.peek()==="."&&this.isDigit(this.peekNext()))for(this.advance();this.isDigit(this.peek());)this.advance();if(this.peek()==="e"||this.peek()==="E")for(this.advance(),(this.peek()==="+"||this.peek()==="-")&&this.advance();this.isDigit(this.peek());)this.advance();let r=this.source.substring(this.start,this.current);this.tokens.push({type:"NUMBER",lexeme:r,literal:parseFloat(r),line:this.line,column:e})}isHexDigit(e){return this.isDigit(e)||e>="a"&&e<="f"||e>="A"&&e<="F"}identifier(){let e=this.column-1;for(;this.isAlphaNumeric(this.peek());)this.advance();let t=this.source.substring(this.start,this.current);if(t==="_"){this.tokens.push({type:"UNDERSCORE",lexeme:t,literal:null,line:this.line,column:e});return}let r=O[t]??"IDENTIFIER",s=null;r==="TRUE"?s=!0:r==="FALSE"&&(s=!1),this.tokens.push({type:r,lexeme:t,literal:s,line:this.line,column:e})}advance(){let e=this.source[this.current];return this.current++,this.column++,e}match(e){return this.isAtEnd()||this.source[this.current]!==e?!1:(this.current++,this.column++,!0)}peek(){return this.isAtEnd()?"\0":this.source[this.current]}peekNext(){return this.current+1>=this.source.length?"\0":this.source[this.current+1]}isAtEnd(){return this.current>=this.source.length}isDigit(e){return e>="0"&&e<="9"}isAlpha(e){return e>="a"&&e<="z"||e>="A"&&e<="Z"||e==="_"}isAlphaNumeric(e){return this.isAlpha(e)||this.isDigit(e)}addToken(e,t=null){let r=this.source.substring(this.start,this.current);this.tokens.push({type:e,lexeme:r,literal:t,line:this.line,column:this.column-r.length})}};var x=class{tokens;current=0;constructor(e){this.tokens=e.filter(t=>t.type!=="COMMENT"&&t.type!=="FOUNDATION")}parse(){let e=[];for(;!this.isAtEnd();){let t=this.declaration();t&&e.push(t)}return{type:"Program",body:e}}declaration(){return this.check("DRAW")?this.drawBlock():this.check("UPDATE")?this.updateBlock():this.check("FUN")?this.functionDeclaration():this.check("ENUM")?this.enumDeclaration():this.check("RETURN")?this.returnStatement():this.check("IF")?this.ifStatement():this.check("LOOP")?this.loopStatement():this.check("BREAK")?this.breakStatement():this.expressionStatement()}functionDeclaration(){this.advance();let e=this.consume("IDENTIFIER","Expected function name");this.consume("LPAREN","Expected '(' after function name");let t=[];if(!this.check("RPAREN"))do{let s=this.consume("IDENTIFIER","Expected parameter name");t.push(s.lexeme)}while(this.match("COMMA"));this.consume("RPAREN","Expected ')' after parameters"),this.consume("LBRACE","Expected '{' before function body");let r=this.blockStatement();return{type:"FunctionDeclaration",name:e.lexeme,parameters:t,body:r}}returnStatement(){this.advance();let e=null;return!this.check("RBRACE")&&!this.isAtEnd()&&(e=this.expression()),{type:"ReturnStatement",argument:e}}loopStatement(){return this.advance(),this.consume("LBRACE","Expected '{' after 'loop'"),{type:"LoopStatement",body:this.blockStatement()}}breakStatement(){return this.advance(),{type:"BreakStatement"}}enumDeclaration(){this.advance();let e=this.consume("IDENTIFIER","Expected enum name");this.consume("LBRACE","Expected '{' after enum name");let t=[];if(!this.check("RBRACE"))do{let r=this.consume("IDENTIFIER","Expected variant name"),s=[];if(this.match("LPAREN")){if(!this.check("RPAREN"))do{let a=this.consume("IDENTIFIER","Expected field name");s.push(a.lexeme)}while(this.match("COMMA"));this.consume("RPAREN","Expected ')' after variant fields")}t.push({name:r.lexeme,fields:s})}while(this.match("COMMA"));return this.consume("RBRACE","Expected '}' after enum variants"),{type:"EnumDeclaration",name:e.lexeme,variants:t}}drawBlock(){return this.advance(),this.consume("LBRACE","Expected '{' after 'draw'"),{type:"DrawBlock",body:this.blockStatement()}}updateBlock(){this.advance(),this.consume("LPAREN","Expected '(' after 'update'");let e=this.consume("IDENTIFIER","Expected parameter name");this.consume("RPAREN","Expected ')' after parameter"),this.consume("LBRACE","Expected '{' after 'update(...)'");let t=this.blockStatement();return{type:"UpdateBlock",parameter:e.lexeme,body:t}}ifStatement(){this.advance(),this.consume("LPAREN","Expected '(' after 'if'");let e=this.expression();this.consume("RPAREN","Expected ')' after condition"),this.consume("LBRACE","Expected '{' after 'if (...)'");let t=this.blockStatement(),r=null;return this.match("ELSE")&&(this.check("IF")?r=this.ifStatement():(this.consume("LBRACE","Expected '{' after 'else'"),r=this.blockStatement())),{type:"IfStatement",condition:e,consequent:t,alternate:r}}blockStatement(){let e=[];for(;!this.check("RBRACE")&&!this.isAtEnd();){let t=this.declaration();t&&e.push(t)}return this.consume("RBRACE","Expected '}' after block"),{type:"BlockStatement",body:e}}expressionStatement(){let e=this.expression();if(e.type==="AssignmentExpression"){let t=e;if(t.left.type==="Identifier")return{type:"VariableDeclaration",name:t.left.name,init:t.right}}return{type:"ExpressionStatement",expression:e}}expression(){return this.assignment()}assignment(){let e=this.logicalOr();if(this.match("EQUAL")){let t=this.assignment();if(e.type==="Identifier"||e.type==="MemberExpression"||e.type==="IndexExpression")return{type:"AssignmentExpression",left:e,right:t};throw new Error("Invalid assignment target")}return e}logicalOr(){let e=this.logicalAnd();for(;this.match("OR","PIPE_PIPE");){let t=this.previous().type==="OR"?"or":"||",r=this.logicalAnd();e={type:"BinaryExpression",operator:t,left:e,right:r}}return e}logicalAnd(){let e=this.bitwiseOr();for(;this.match("AND","AMPERSAND_AMPERSAND");){let t=this.previous().type==="AND"?"and":"&&",r=this.bitwiseOr();e={type:"BinaryExpression",operator:t,left:e,right:r}}return e}bitwiseOr(){let e=this.bitwiseXor();for(;this.match("PIPE");){let t=this.bitwiseXor();e={type:"BinaryExpression",operator:"|",left:e,right:t}}return e}bitwiseXor(){let e=this.bitwiseAnd();for(;this.match("CARET");){let t=this.bitwiseAnd();e={type:"BinaryExpression",operator:"^",left:e,right:t}}return e}bitwiseAnd(){let e=this.equality();for(;this.match("AMPERSAND");){let t=this.equality();e={type:"BinaryExpression",operator:"&",left:e,right:t}}return e}equality(){let e=this.comparison();for(;this.match("EQUAL_EQUAL","BANG_EQUAL");){let t=this.previous().lexeme,r=this.comparison();e={type:"BinaryExpression",operator:t,left:e,right:r}}return e}comparison(){let e=this.shift();for(;this.match("LESS","LESS_EQUAL","GREATER","GREATER_EQUAL");){let t=this.previous().lexeme,r=this.shift();e={type:"BinaryExpression",operator:t,left:e,right:r}}return e}shift(){let e=this.term();for(;this.match("LESS_LESS","GREATER_GREATER");){let t=this.previous().lexeme,r=this.term();e={type:"BinaryExpression",operator:t,left:e,right:r}}return e}term(){let e=this.factor();for(;this.match("PLUS","MINUS");){let t=this.previous().lexeme,r=this.factor();e={type:"BinaryExpression",operator:t,left:e,right:r}}return e}factor(){let e=this.exponentiation();for(;this.match("STAR","SLASH","PERCENT");){let t=this.previous().lexeme,r=this.exponentiation();e={type:"BinaryExpression",operator:t,left:e,right:r}}return e}exponentiation(){let e=this.unary();if(this.match("STAR_STAR")){let t=this.exponentiation();return{type:"BinaryExpression",operator:"**",left:e,right:t}}return e}unary(){if(this.match("BANG","MINUS","TILDE")){let e=this.previous().lexeme,t=this.unary();return{type:"UnaryExpression",operator:e,argument:t}}return this.call()}call(){let e=this.primary();for(;;)if(this.match("LPAREN"))e=this.finishCall(e);else if(this.match("DOT")){let t=this.consume("IDENTIFIER","Expected property name after '.'");e={type:"MemberExpression",object:e,property:{type:"Identifier",name:t.lexeme}}}else if(this.match("LBRACKET"))e=this.finishIndexOrSlice(e);else break;return e}finishIndexOrSlice(e){let t=null,r=null,s=!1;return this.check("COLON")?s=!0:this.check("RBRACKET")||(t=this.expression()),this.match("COLON")&&(s=!0,this.check("RBRACKET")||(r=this.expression())),this.consume("RBRACKET","Expected ']' after index/slice"),s?{type:"SliceExpression",object:e,start:t,end:r}:{type:"IndexExpression",object:e,index:t}}finishCall(e){let t=[],r=!1;if(!this.check("RPAREN"))do if(this.check("IDENTIFIER")&&this.peekNext()?.type==="EQUAL"){let s=this.advance().lexeme;this.advance();let a=this.expression();t.push({name:s,value:a}),r=!0}else{if(r)throw new Error(`Positional argument cannot follow keyword argument at line ${this.peek().line}`);t.push({name:null,value:this.expression()})}while(this.match("COMMA"));return this.consume("RPAREN","Expected ')' after arguments"),{type:"CallExpression",callee:e,arguments:t}}peekNext(){return this.current+1>=this.tokens.length?null:this.tokens[this.current+1]}primary(){if(this.match("TRUE"))return{type:"BooleanLiteral",value:!0};if(this.match("FALSE"))return{type:"BooleanLiteral",value:!1};if(this.match("NUMBER"))return{type:"NumberLiteral",value:this.previous().literal};if(this.match("STRING"))return{type:"StringLiteral",value:this.previous().literal};if(this.match("PROTOTYPE"))return this.consume("LPAREN","Expected '(' after 'prototype'"),this.consume("RPAREN","Expected ')' after 'prototype('"),{type:"PrototypeExpression"};if(this.match("IDENTIFIER"))return{type:"Identifier",name:this.previous().lexeme};if(this.match("LPAREN")){let e=this.expression();return this.consume("RPAREN","Expected ')' after expression"),e}if(this.match("LBRACKET")){let e=[];if(!this.check("RBRACKET"))do e.push(this.expression());while(this.match("COMMA"));return this.consume("RBRACKET","Expected ']' after array elements"),{type:"ArrayLiteral",elements:e}}if(this.match("LBRACE"))return this.objectLiteral();if(this.match("MATCH"))return this.matchExpression();throw new Error(`Unexpected token: ${this.peek().lexeme} at line ${this.peek().line}`)}match(...e){for(let t of e)if(this.check(t))return this.advance(),!0;return!1}check(e){return this.isAtEnd()?!1:this.peek().type===e}advance(){return this.isAtEnd()||this.current++,this.previous()}isAtEnd(){return this.peek().type==="EOF"}peek(){return this.tokens[this.current]}previous(){return this.tokens[this.current-1]}consume(e,t){if(this.check(e))return this.advance();throw new Error(`${t}. Got: ${this.peek().lexeme} at line ${this.peek().line}`)}objectLiteral(){let e=[];if(!this.check("RBRACE"))do{let t=this.consume("IDENTIFIER","Expected property name");this.consume("COLON","Expected ':' after property name");let r=this.expression();e.push({key:t.lexeme,value:r})}while(this.match("COMMA"));return this.consume("RBRACE","Expected '}' after object properties"),{type:"ObjectLiteral",properties:e}}matchExpression(){let e=this.expression();this.consume("LBRACE","Expected '{' after match subject");let t=[];if(!this.check("RBRACE"))do{let r=this.pattern();this.consume("FAT_ARROW","Expected '=>' after pattern");let s=this.expression();t.push({pattern:r,body:s})}while(this.match("COMMA"));return this.consume("RBRACE","Expected '}' after match arms"),{type:"MatchExpression",subject:e,arms:t}}pattern(){if(this.match("UNDERSCORE"))return{type:"WildcardPattern"};if(this.match("NUMBER"))return{type:"LiteralPattern",value:this.previous().literal};if(this.match("STRING"))return{type:"LiteralPattern",value:this.previous().literal};if(this.match("TRUE"))return{type:"LiteralPattern",value:!0};if(this.match("FALSE"))return{type:"LiteralPattern",value:!1};if(this.match("IDENTIFIER")){let e=this.previous().lexeme;if(this.match("LPAREN")){let t=[];if(!this.check("RPAREN"))do{let r=this.consume("IDENTIFIER","Expected binding name");t.push(r.lexeme)}while(this.match("COMMA"));return this.consume("RPAREN","Expected ')' after variant bindings"),{type:"VariantPattern",enumName:null,variantName:e,bindings:t}}return{type:"IdentifierPattern",name:e}}throw new Error(`Unexpected pattern at line ${this.peek().line}`)}};var v=class{grid;foundationRow=-1;height;width;supportCache=new Map;checkingStack=new Set;constructor(e){let t=e.split(`
`);this.height=t.length,this.width=Math.max(...t.map(r=>r.length),0),this.grid=[];for(let r=0;r<this.height;r++){this.grid[r]=[];let s=t[r]||"";for(let a=0;a<this.width;a++)this.grid[r][a]=a<s.length?s[a]:" "}this.findFoundation()}findFoundation(){for(let e=this.height-1;e>=0;e--){let t=!1;for(let r=0;r<this.width;r++){let s=this.grid[e][r];if(s==='"'){t=!t;continue}if(s==="#"&&!t){this.foundationRow=e;return}}}}posKey(e,t){return`${e},${t}`}isSupported(e,t){let r=this.posKey(e,t);if(this.supportCache.has(r))return this.supportCache.get(r);if(this.checkingStack.has(r))return!1;this.checkingStack.add(r);let s=this.isSupportedInternal(e,t);return this.checkingStack.delete(r),this.supportCache.set(r,s),s}isSupportedInternal(e,t){if(this.grid[e][t]===" ")return!1;if(e===this.foundationRow&&this.grid[e][t]==="#")return!0;if(e>=this.foundationRow&&this.foundationRow!==-1||this.foundationRow===-1)return!1;let r=e+1;if(r>=this.height)return!1;let s=[t-1,t,t+1];for(let a of s)if(a>=0&&a<this.width){let n=this.grid[r][a];if(n!==" "&&n!==void 0&&this.isSupported(r,a))return!0}return!1}findLandingRow(e,t){for(let r=e+1;r<this.height;r++)if(this.grid[r][t]!==" ")return r-1;return-1}process(){if(this.foundationRow===-1)return"";let e=!0,t=0,r=this.height*this.width;for(;e&&t<r;){e=!1,t++,this.supportCache.clear();for(let s=this.foundationRow-1;s>=0;s--){let a=[];for(let n=0;n<this.width;n++){let i=this.grid[s][n];i!==" "&&!this.isSupported(s,n)&&a.push({col:n,char:i})}if(a.length>0){for(let{col:n}of a)this.grid[s][n]=" ";for(let{col:n,char:i}of a){let o=this.findLandingRow(s,n);o>=0&&o<this.height&&(this.grid[o][n]=i)}e=!0,this.supportCache.clear()}}}return this.gridToString()}gridToString(){return this.grid.map(e=>e.join("").replace(/\s+$/,"")).join(`
`)}getGrid(){return this.grid.map(e=>[...e])}getUnsupportedPositions(){this.supportCache.clear();let e=[];if(this.foundationRow===-1){for(let t=0;t<this.height;t++)for(let r=0;r<this.width;r++)this.grid[t][r]!==" "&&e.push({row:t,col:r});return e}for(let t=0;t<this.foundationRow;t++)for(let r=0;r<this.width;r++)this.grid[t][r]!==" "&&!this.isSupported(t,r)&&e.push({row:t,col:r});return e}getFoundationRow(){return this.foundationRow}};var B={left:["ArrowLeft","KeyA"],right:["ArrowRight","KeyD"],up:["ArrowUp","KeyW"],down:["ArrowDown","KeyS"],jump:["Space","KeyZ"],action:["Enter","KeyX"],start:["Escape"],select:["Tab"],a:["Space","KeyZ"],b:["Enter","KeyX"]},C={jump:[0],action:[1],a:[0],b:[1],start:[9],select:[8]},M=.5,E=class{canvas=null;keysDown=new Set;keysPressedBuffer=new Set;keysPressed=new Set;keysReleasedBuffer=new Set;keysReleased=new Set;mouseX=0;mouseY=0;mouseButtons=new Set;mouseJustPressedBuffer=new Set;mouseJustPressed=new Set;mouseJustReleasedBuffer=new Set;mouseJustReleased=new Set;touches=new Map;touchJustStartedBuffer=!1;touchJustStarted=!1;touchJustEndedBuffer=!1;touchJustEnded=!1;gamepadIndex=null;prevGamepadButtons=[];inputBuffer=new Map;initialized=!1;constructor(e={}){e.canvas&&this.setCanvas(e.canvas)}setCanvas(e){this.canvas=e,this.init()}init(){if(this.initialized||typeof window>"u")return;window.addEventListener("keydown",this.onKeyDown),window.addEventListener("keyup",this.onKeyUp);let e=this.canvas||window;e.addEventListener("mousedown",this.onMouseDown),e.addEventListener("mouseup",this.onMouseUp),e.addEventListener("mousemove",this.onMouseMove),e.addEventListener("touchstart",this.onTouchStart),e.addEventListener("touchend",this.onTouchEnd),e.addEventListener("touchmove",this.onTouchMove),window.addEventListener("gamepadconnected",this.onGamepadConnected),window.addEventListener("gamepaddisconnected",this.onGamepadDisconnected),this.canvas&&this.canvas.addEventListener("contextmenu",t=>t.preventDefault()),this.initialized=!0}update(){this.keysPressed=this.keysPressedBuffer,this.keysPressedBuffer=new Set,this.keysReleased=this.keysReleasedBuffer,this.keysReleasedBuffer=new Set,this.mouseJustPressed=this.mouseJustPressedBuffer,this.mouseJustPressedBuffer=new Set,this.mouseJustReleased=this.mouseJustReleasedBuffer,this.mouseJustReleasedBuffer=new Set,this.touchJustStarted=this.touchJustStartedBuffer,this.touchJustStartedBuffer=!1,this.touchJustEnded=this.touchJustEndedBuffer,this.touchJustEndedBuffer=!1,this.pollGamepad()}endFrame(){}pressed(e){let t=B[e.toLowerCase()];if(t){for(let r of t)if(this.keysPressed.has(r))return!0}return!!this.isGamepadActionPressed(e)}held(e){let t=B[e.toLowerCase()];if(t){for(let r of t)if(this.keysDown.has(r))return!0}return!!(this.isGamepadActionHeld(e)||this.isGamepadDirectionHeld(e))}released(e){let t=B[e.toLowerCase()];if(t){for(let r of t)if(this.keysReleased.has(r))return!0}return!!this.isGamepadActionReleased(e)}keyPressed(e){return this.keysPressed.has(this.normalizeKey(e))}keyHeld(e){return this.keysDown.has(this.normalizeKey(e))}keyReleased(e){return this.keysReleased.has(this.normalizeKey(e))}normalizeKey(e){let t={space:"Space",enter:"Enter",escape:"Escape",tab:"Tab",shift:"ShiftLeft",ctrl:"ControlLeft",alt:"AltLeft",left:"ArrowLeft",right:"ArrowRight",up:"ArrowUp",down:"ArrowDown"},r=e.toLowerCase();return t[r]?t[r]:e.length===1?`Key${e.toUpperCase()}`:e}bufferInput(e,t){let r=performance.now()+t*1e3;this.inputBuffer.set(e.toLowerCase(),r)}checkBuffer(e){let t=e.toLowerCase(),r=this.inputBuffer.get(t);return r===void 0?!1:performance.now()>r?(this.inputBuffer.delete(t),!1):(this.inputBuffer.delete(t),!0)}peekBuffer(e){let t=e.toLowerCase(),r=this.inputBuffer.get(t);return r===void 0?!1:performance.now()>r?(this.inputBuffer.delete(t),!1):!0}clearBuffer(e){this.inputBuffer.delete(e.toLowerCase())}clearAllBuffers(){this.inputBuffer.clear()}getBufferTime(e){let t=e.toLowerCase(),r=this.inputBuffer.get(t);if(r===void 0)return 0;let s=(r-performance.now())/1e3;return s<=0?(this.inputBuffer.delete(t),0):s}getMouseX(){return this.mouseX}getMouseY(){return this.mouseY}mousePressed(e=0){return this.mouseJustPressed.has(e)||e===0&&this.touchJustStarted}mouseHeld(e=0){return this.mouseButtons.has(e)||e===0&&this.touches.size>0}mouseReleased(e=0){return this.mouseJustReleased.has(e)||e===0&&this.touchJustEnded}getTouchCount(){return this.touches.size}getTouchPosition(e){return Array.from(this.touches.values())[e]||null}pollGamepad(){if(this.gamepadIndex===null)return;let t=navigator.getGamepads()[this.gamepadIndex];if(!t)return;let r=t.buttons.map(s=>s.pressed);this.prevGamepadButtons=r}getGamepad(){return this.gamepadIndex===null?null:navigator.getGamepads()[this.gamepadIndex]||null}isGamepadActionPressed(e){let t=this.getGamepad();if(!t)return!1;let r=C[e.toLowerCase()];if(!r)return!1;for(let s of r){let a=t.buttons[s]?.pressed??!1,n=this.prevGamepadButtons[s]??!1;if(a&&!n)return!0}return!1}isGamepadActionHeld(e){let t=this.getGamepad();if(!t)return!1;let r=C[e.toLowerCase()];if(!r)return!1;for(let s of r)if(t.buttons[s]?.pressed)return!0;return!1}isGamepadActionReleased(e){let t=this.getGamepad();if(!t)return!1;let r=C[e.toLowerCase()];if(!r)return!1;for(let s of r){let a=t.buttons[s]?.pressed??!1,n=this.prevGamepadButtons[s]??!1;if(!a&&n)return!0}return!1}isGamepadDirectionHeld(e){let t=this.getGamepad();if(!t)return!1;let r=t.axes;switch(e.toLowerCase()){case"left":return r[0]<-M||t.buttons[14]?.pressed;case"right":return r[0]>M||t.buttons[15]?.pressed;case"up":return r[1]<-M||t.buttons[12]?.pressed;case"down":return r[1]>M||t.buttons[13]?.pressed}return!1}GAME_KEYS=new Set(["Space","ArrowUp","ArrowDown","ArrowLeft","ArrowRight","KeyW","KeyA","KeyS","KeyD","KeyZ","KeyX"]);onKeyDown=e=>{this.GAME_KEYS.has(e.code)&&e.preventDefault(),this.keysDown.has(e.code)||this.keysPressedBuffer.add(e.code),this.keysDown.add(e.code)};onKeyUp=e=>{this.GAME_KEYS.has(e.code)&&e.preventDefault(),this.keysDown.delete(e.code),this.keysReleasedBuffer.add(e.code)};onMouseDown=e=>{this.mouseButtons.add(e.button),this.mouseJustPressedBuffer.add(e.button),this.updateMousePosition(e)};onMouseUp=e=>{this.mouseButtons.delete(e.button),this.mouseJustReleasedBuffer.add(e.button)};onMouseMove=e=>{this.updateMousePosition(e)};updateMousePosition(e){if(this.canvas){let t=this.canvas.getBoundingClientRect();this.mouseX=e.clientX-t.left,this.mouseY=e.clientY-t.top}else this.mouseX=e.clientX,this.mouseY=e.clientY}onTouchStart=e=>{this.touchJustStartedBuffer=!0,this.updateTouches(e),e.touches.length>0&&this.updateTouchPosition(e.touches[0])};onTouchEnd=e=>{e.touches.length===0?(this.touchJustEndedBuffer=!0,this.touches.clear()):this.updateTouches(e)};onTouchMove=e=>{this.updateTouches(e),e.touches.length>0&&this.updateTouchPosition(e.touches[0])};updateTouches(e){this.touches.clear();for(let t=0;t<e.touches.length;t++){let r=e.touches[t],s=r.clientX,a=r.clientY;if(this.canvas){let n=this.canvas.getBoundingClientRect();s-=n.left,a-=n.top}this.touches.set(r.identifier,{x:s,y:a})}}updateTouchPosition(e){if(this.canvas){let t=this.canvas.getBoundingClientRect();this.mouseX=e.clientX-t.left,this.mouseY=e.clientY-t.top}else this.mouseX=e.clientX,this.mouseY=e.clientY}onGamepadConnected=e=>{console.log("Gamepad connected:",e.gamepad.id),this.gamepadIndex=e.gamepad.index};onGamepadDisconnected=e=>{console.log("Gamepad disconnected:",e.gamepad.id),this.gamepadIndex===e.gamepad.index&&(this.gamepadIndex=null,this.prevGamepadButtons=[])};dispose(){if(typeof window>"u")return;window.removeEventListener("keydown",this.onKeyDown),window.removeEventListener("keyup",this.onKeyUp);let e=this.canvas||window;e.removeEventListener("mousedown",this.onMouseDown),e.removeEventListener("mouseup",this.onMouseUp),e.removeEventListener("mousemove",this.onMouseMove),e.removeEventListener("touchstart",this.onTouchStart),e.removeEventListener("touchend",this.onTouchEnd),e.removeEventListener("touchmove",this.onTouchMove),window.removeEventListener("gamepadconnected",this.onGamepadConnected),window.removeEventListener("gamepaddisconnected",this.onGamepadDisconnected),this.initialized=!1}};var y=class{audioContext=null;masterGain=null;musicElement=null;soundCache=new Map;activeSounds=new Set;masterVolume;initialized=!1;constructor(e={}){this.masterVolume=e.masterVolume??1}init(){if(!this.initialized)try{this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.masterGain=this.audioContext.createGain(),this.masterGain.gain.value=this.masterVolume,this.masterGain.connect(this.audioContext.destination),this.initialized=!0}catch{console.warn("Web Audio API not supported, audio disabled")}}async resume(){this.audioContext?.state==="suspended"&&await this.audioContext.resume()}async music(e,t=5){if(this.musicElement&&(this.musicElement.pause(),this.musicElement.src="",this.musicElement=null),!!e){this.musicElement=new Audio(e),this.musicElement.loop=!0,this.musicElement.volume=Math.min(1,Math.max(0,t/10));try{await this.musicElement.play()}catch(r){console.warn(`Failed to play music: ${e}`,r)}}}stopMusic(){this.musicElement&&(this.musicElement.pause(),this.musicElement.src="",this.musicElement=null)}setMusicVolume(e){this.musicElement&&(this.musicElement.volume=Math.min(1,Math.max(0,e/10)))}async sound(e,t=5){if(this.init(),!this.audioContext||!this.masterGain){let r=new Audio(e);r.volume=Math.min(1,Math.max(0,t/10));try{await r.play()}catch(s){console.warn(`Failed to play sound: ${e}`,s)}return}await this.resume();try{let r=this.soundCache.get(e);if(!r){let i=await(await fetch(e)).arrayBuffer();r=await this.audioContext.decodeAudioData(i),this.soundCache.set(e,r)}let s=this.audioContext.createBufferSource(),a=this.audioContext.createGain();s.buffer=r,a.gain.value=Math.min(1,Math.max(0,t/10)),s.connect(a),a.connect(this.masterGain),this.activeSounds.add(s),s.onended=()=>{this.activeSounds.delete(s)},s.start(0)}catch(r){console.warn(`Failed to play sound: ${e}`,r)}}stopAllSounds(){for(let e of this.activeSounds)try{e.stop()}catch{}this.activeSounds.clear()}setMasterVolume(e){this.masterVolume=Math.min(1,Math.max(0,e/10)),this.masterGain&&(this.masterGain.gain.value=this.masterVolume)}dispose(){this.stopMusic(),this.stopAllSounds(),this.audioContext&&(this.audioContext.close(),this.audioContext=null),this.soundCache.clear(),this.initialized=!1}};function U(l,e,t){let r=new Map,s=e??new y,a=t??new E;return r.set("text",(n,i,o,h=16,c="#ffffff",m=1)=>(l.text(String(n),Number(i),Number(o),Number(h),String(c),Number(m)),null)),r.set("sprite",(n,i,o,h=32,c=32,m=null,f=null,p=null,d=null,S="#ffffff",L=1)=>(l.sprite(n?String(n):null,Number(i),Number(o),Number(h),Number(c),m!==null?Number(m):null,f!==null?Number(f):null,p!==null?Number(p):null,d!==null?Number(d):null,String(S),Number(L)),null)),r.set("clear",(n="#000000")=>(l.clear(String(n)),null)),r.set("rect",(n,i,o,h,c,m=1)=>(l.rect(Number(n),Number(i),Number(o),Number(h),String(c),Number(m)),null)),r.set("circle",(n,i,o,h,c=1)=>(l.circle(Number(n),Number(i),Number(o),String(h),Number(c)),null)),r.set("line",(n,i,o,h,c,m=1,f=1)=>(l.line(Number(n),Number(i),Number(o),Number(h),String(c),Number(m),Number(f)),null)),r.set("abs",n=>Math.abs(Number(n))),r.set("floor",n=>Math.floor(Number(n))),r.set("ceil",n=>Math.ceil(Number(n))),r.set("round",n=>Math.round(Number(n))),r.set("min",(n,i)=>Math.min(Number(n),Number(i))),r.set("max",(n,i)=>Math.max(Number(n),Number(i))),r.set("sin",n=>Math.sin(Number(n))),r.set("cos",n=>Math.cos(Number(n))),r.set("tan",n=>Math.tan(Number(n))),r.set("asin",n=>Math.asin(Number(n))),r.set("acos",n=>Math.acos(Number(n))),r.set("atan",n=>Math.atan(Number(n))),r.set("atan2",(n,i)=>Math.atan2(Number(n),Number(i))),r.set("sinh",n=>Math.sinh(Number(n))),r.set("cosh",n=>Math.cosh(Number(n))),r.set("tanh",n=>Math.tanh(Number(n))),r.set("PI",()=>Math.PI),r.set("TAU",()=>Math.PI*2),r.set("E",()=>Math.E),r.set("deg",n=>Number(n)*(180/Math.PI)),r.set("rad",n=>Number(n)*(Math.PI/180)),r.set("sqrt",n=>Math.sqrt(Number(n))),r.set("pow",(n,i)=>Math.pow(Number(n),Number(i))),r.set("log",n=>Math.log(Number(n))),r.set("log10",n=>Math.log10(Number(n))),r.set("exp",n=>Math.exp(Number(n))),r.set("random",()=>Math.random()),r.set("randomInt",(n,i)=>{let o=Math.floor(Number(n)),h=Math.floor(Number(i));return Math.floor(Math.random()*(h-o+1))+o}),r.set("print",(...n)=>(console.log(...n.map(i=>String(i))),null)),r.set("lerp",(n,i,o)=>{let h=Number(n),c=Number(i),m=Number(o);return h+(c-h)*m}),r.set("clamp",(n,i,o)=>Math.max(Number(i),Math.min(Number(o),Number(n)))),r.set("sign",n=>Math.sign(Number(n))),r.set("distance",(n,i,o,h)=>{let c=Number(o)-Number(n),m=Number(h)-Number(i);return Math.sqrt(c*c+m*m)}),r.set("rect_overlap",(n,i,o,h,c,m,f,p)=>{let d=Number(n),S=Number(i),L=Number(o),K=Number(h),D=Number(c),_=Number(m),j=Number(f),$=Number(p);return d<D+j&&d+L>D&&S<_+$&&S+K>_}),r.set("array",(n=0)=>{let i=Math.max(0,Math.floor(Number(n)));return new Array(i).fill(null)}),r.set("len",n=>Array.isArray(n)||typeof n=="string"?n.length:0),r.set("push",(n,i)=>Array.isArray(n)?(n.push(i),n.length):null),r.set("pop",n=>Array.isArray(n)?n.pop()??null:null),r.set("sort",n=>Array.isArray(n)?(n.sort((i,o)=>typeof i=="number"&&typeof o=="number"?i-o:String(i).localeCompare(String(o))),n):null),r.set("sorted",n=>{if(Array.isArray(n)){let i=[...n];return i.sort((o,h)=>typeof o=="number"&&typeof h=="number"?o-h:String(o).localeCompare(String(h))),i}return null}),r.set("reverse",n=>Array.isArray(n)?(n.reverse(),n):null),r.set("reversed",n=>Array.isArray(n)?[...n].reverse():null),r.set("slice",(n,i=0,o=null)=>{if(Array.isArray(n)){let h=Number(i)|0,c=o===null?n.length:Number(o)|0;return n.slice(h,c)}if(typeof n=="string"){let h=Number(i)|0,c=o===null?n.length:Number(o)|0;return n.slice(h,c)}return null}),r.set("index",(n,i)=>Array.isArray(n)||typeof n=="string"&&typeof i=="string"?n.indexOf(i):-1),r.set("contains",(n,i)=>Array.isArray(n)||typeof n=="string"&&typeof i=="string"?n.includes(i):!1),r.set("insert",(n,i,o)=>{if(Array.isArray(n)){let h=Number(i)|0;return n.splice(h,0,o),n.length}return null}),r.set("remove",(n,i)=>{if(Array.isArray(n)){let o=n.indexOf(i);return o!==-1?(n.splice(o,1),!0):!1}return!1}),r.set("extend",(n,i)=>Array.isArray(n)&&Array.isArray(i)?(n.push(...i),n.length):null),r.set("count",(n,i)=>Array.isArray(n)?n.filter(o=>o===i).length:typeof n=="string"&&typeof i=="string"?n.split(i).length-1:0),r.set("join",(n,i=",")=>Array.isArray(n)?n.map(o=>String(o)).join(String(i)):""),r.set("time",()=>performance.now()/1e3),r.set("rgba",(n,i,o,h=1)=>`rgba(${Math.floor(Number(n))}, ${Math.floor(Number(i))}, ${Math.floor(Number(o))}, ${Number(h)})`),r.set("rgb",(n,i,o)=>`rgb(${Math.floor(Number(n))}, ${Math.floor(Number(i))}, ${Math.floor(Number(o))})`),r.set("hsla",(n,i,o,h=1)=>`hsla(${Number(n)}, ${Number(i)}%, ${Number(o)}%, ${Number(h)})`),r.set("hsl",(n,i,o)=>`hsl(${Number(n)}, ${Number(i)}%, ${Number(o)}%)`),r.set("music",(n=null,i=5)=>(s.music(n?String(n):null,Number(i)),null)),r.set("stop_music",()=>(s.stopMusic(),null)),r.set("music_volume",n=>(s.setMusicVolume(Number(n)),null)),r.set("sound",(n,i=5)=>(n&&s.sound(String(n),Number(i)),null)),r.set("stop_sounds",()=>(s.stopAllSounds(),null)),r.set("master_volume",n=>(s.setMasterVolume(Number(n)),null)),r.set("pressed",n=>a.pressed(String(n))),r.set("held",n=>a.held(String(n))),r.set("released",n=>a.released(String(n))),r.set("key_pressed",n=>a.keyPressed(String(n))),r.set("key_held",n=>a.keyHeld(String(n))),r.set("key_released",n=>a.keyReleased(String(n))),r.set("mouse_x",()=>a.getMouseX()),r.set("mouse_y",()=>a.getMouseY()),r.set("mouse_pressed",(n=0)=>a.mousePressed(Number(n)|0)),r.set("mouse_held",(n=0)=>a.mouseHeld(Number(n)|0)),r.set("mouse_released",(n=0)=>a.mouseReleased(Number(n)|0)),r.set("touch_count",()=>a.getTouchCount()),r.set("touch_x",(n=0)=>{let i=a.getTouchPosition(Number(n)|0);return i?i.x:0}),r.set("touch_y",(n=0)=>{let i=a.getTouchPosition(Number(n)|0);return i?i.y:0}),r.set("buffer_input",(n,i=.1)=>(a.bufferInput(String(n),Number(i)),null)),r.set("check_buffer",n=>a.checkBuffer(String(n))),r.set("peek_buffer",n=>a.peekBuffer(String(n))),r.set("clear_buffer",n=>(a.clearBuffer(String(n)),null)),r.set("clear_all_buffers",()=>(a.clearAllBuffers(),null)),r.set("buffer_time",n=>a.getBufferTime(String(n))),r}function I(){return{__type:"prototype"}}function A(l){return typeof l=="object"&&l!==null&&!Array.isArray(l)&&l.__type==="prototype"}function F(l){return typeof l=="object"&&l!==null&&!Array.isArray(l)&&l.__type==="enum_variant_def"}function P(l){return typeof l=="object"&&l!==null&&!Array.isArray(l)&&l.__type==="enum_variant"}function T(l,e,t=new Map){return{__type:"enum_variant",enumName:l,variantName:e,data:t}}var b=class{constructor(e){this.value=e}},V=class{};function H(l){return typeof l=="object"&&l!==null&&!Array.isArray(l)&&l.__type==="function"}var g=class{values=new Map;parent;constructor(e=null){this.parent=e}define(e,t){this.values.set(e,t)}get(e){if(this.values.has(e))return this.values.get(e);if(this.parent)return this.parent.get(e);throw new Error(`Undefined variable: ${e}`)}set(e,t){if(this.values.has(e)){this.values.set(e,t);return}if(this.parent){this.parent.set(e,t);return}this.values.set(e,t)}has(e){return this.values.has(e)?!0:this.parent?this.parent.has(e):!1}},w=class l{globalEnv;currentEnv;builtins;inputManager;drawBlock=null;updateBlock=null;animationFrameId=null;lastTime=0;running=!1;constructor(e,t){this.globalEnv=new g,this.currentEnv=this.globalEnv,this.inputManager=t??new E;let r=e.getContext();r?.canvas&&this.inputManager.setCanvas(r.canvas),this.builtins=U(e,void 0,this.inputManager);for(let[s,a]of this.builtins)this.globalEnv.define(s,a)}run(e){for(let t of e.body)this.executeStatement(t)}startGameLoop(){this.running||(this.running=!0,this.lastTime=performance.now(),this.gameLoop())}stopGameLoop(){this.running=!1,this.animationFrameId!==null&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}gameLoop=()=>{if(!this.running)return;let e=performance.now(),t=(e-this.lastTime)/1e3;if(this.lastTime=e,this.inputManager.update(),this.updateBlock){let r=new g(this.globalEnv);r.define(this.updateBlock.parameter,t);let s=this.currentEnv;this.currentEnv=r;try{this.executeBlock(this.updateBlock.body)}catch(a){if(!(a instanceof b))throw a}this.currentEnv=s}if(this.drawBlock){let r=new g(this.globalEnv),s=this.currentEnv;this.currentEnv=r;try{this.executeBlock(this.drawBlock.body)}catch(a){if(!(a instanceof b))throw a}this.currentEnv=s}this.animationFrameId=requestAnimationFrame(this.gameLoop)};executeStatement(e){switch(e.type){case"DrawBlock":this.drawBlock=e;break;case"UpdateBlock":this.updateBlock=e;break;case"FunctionDeclaration":this.executeFunctionDeclaration(e);break;case"EnumDeclaration":this.executeEnumDeclaration(e);break;case"ReturnStatement":this.executeReturn(e);break;case"IfStatement":this.executeIf(e);break;case"LoopStatement":this.executeLoop(e);break;case"BreakStatement":throw new V;case"BlockStatement":this.executeBlock(e);break;case"ExpressionStatement":this.evaluate(e.expression);break;case"VariableDeclaration":this.executeVariableDeclaration(e);break}}executeFunctionDeclaration(e){let t={__type:"function",name:e.name,parameters:e.parameters,body:e.body,closure:this.currentEnv};this.currentEnv.define(e.name,t)}executeEnumDeclaration(e){for(let t of e.variants){let r={__type:"enum_variant_def",enumName:e.name,variantName:t.name,fields:t.fields};if(t.fields.length===0){let s=T(e.name,t.name);this.currentEnv.define(t.name,s)}else this.currentEnv.define(t.name,r)}}executeReturn(e){let t=e.argument?this.evaluate(e.argument):null;throw new b(t)}executeIf(e){let t=this.evaluate(e.condition);this.isTruthy(t)?this.executeBlockStatements(e.consequent):e.alternate&&(e.alternate.type==="IfStatement"?this.executeIf(e.alternate):this.executeBlockStatements(e.alternate))}executeLoop(e){try{for(;;)this.executeBlockStatements(e.body)}catch(t){if(t instanceof V)return;throw t}}executeBlock(e){let t=new g(this.currentEnv),r=this.currentEnv;this.currentEnv=t;try{for(let s of e.body)this.executeStatement(s)}finally{this.currentEnv=r}}executeBlockStatements(e){for(let t of e.body)this.executeStatement(t)}executeVariableDeclaration(e){let t=this.evaluate(e.init);this.currentEnv.set(e.name,t)}evaluate(e){switch(e.type){case"NumberLiteral":return e.value;case"StringLiteral":return e.value;case"BooleanLiteral":return e.value;case"ArrayLiteral":return this.evaluateArrayLiteral(e);case"ObjectLiteral":return this.evaluateObjectLiteral(e);case"MatchExpression":return this.evaluateMatch(e);case"Identifier":return this.currentEnv.get(e.name);case"PrototypeExpression":return I();case"BinaryExpression":return this.evaluateBinary(e);case"UnaryExpression":return this.evaluateUnary(e);case"CallExpression":return this.evaluateCall(e);case"MemberExpression":return this.evaluateMember(e);case"IndexExpression":return this.evaluateIndex(e);case"SliceExpression":return this.evaluateSlice(e);case"AssignmentExpression":return this.evaluateAssignment(e);default:throw new Error(`Unknown expression type: ${e.type}`)}}evaluateArrayLiteral(e){return e.elements.map(t=>this.evaluate(t))}evaluateObjectLiteral(e){let t=I();for(let r of e.properties)t[r.key]=this.evaluate(r.value);return t}evaluateMatch(e){let t=this.evaluate(e.subject);for(let r of e.arms){let s=this.matchPattern(r.pattern,t);if(s!==null){let a=new g(this.currentEnv);for(let[i,o]of s)a.define(i,o);let n=this.currentEnv;this.currentEnv=a;try{return this.evaluate(r.body)}finally{this.currentEnv=n}}}throw new Error("Non-exhaustive match: no pattern matched")}matchPattern(e,t){switch(e.type){case"WildcardPattern":return new Map;case"LiteralPattern":return t===e.value?new Map:null;case"IdentifierPattern":return e.name.length>0&&e.name[0]===e.name[0].toUpperCase()&&e.name[0]!==e.name[0].toLowerCase()?!P(t)||t.variantName!==e.name?null:new Map:new Map([[e.name,t]]);case"VariantPattern":{if(!P(t)||t.variantName!==e.variantName||e.enumName!==null&&t.enumName!==e.enumName)return null;let r=new Map,s=Array.from(t.data.entries());for(let a=0;a<e.bindings.length;a++){let n=e.bindings[a];a<s.length?r.set(n,s[a][1]):r.set(n,null)}return r}default:return null}}evaluateBinary(e){let t=this.evaluate(e.left),r=this.evaluate(e.right);switch(e.operator){case"+":return typeof t=="string"||typeof r=="string"?String(t)+String(r):Number(t)+Number(r);case"-":return Number(t)-Number(r);case"*":return Number(t)*Number(r);case"/":return Number(t)/Number(r);case"%":return Number(t)%Number(r);case"**":return Math.pow(Number(t),Number(r));case"==":return t===r;case"!=":return t!==r;case"<":return Number(t)<Number(r);case"<=":return Number(t)<=Number(r);case">":return Number(t)>Number(r);case">=":return Number(t)>=Number(r);case"and":return this.isTruthy(t)?r:t;case"or":return this.isTruthy(t)?t:r;case"&&":return this.isTruthy(t)?r:t;case"||":return this.isTruthy(t)?t:r;case"&":return(Number(t)|0)&(Number(r)|0);case"|":return Number(t)|0|(Number(r)|0);case"^":return(Number(t)|0)^(Number(r)|0);case"<<":return(Number(t)|0)<<(Number(r)|0);case">>":return(Number(t)|0)>>(Number(r)|0);default:throw new Error(`Unknown operator: ${e.operator}`)}}evaluateUnary(e){let t=this.evaluate(e.argument);switch(e.operator){case"-":return-Number(t);case"!":return!this.isTruthy(t);case"~":return~(Number(t)|0);default:throw new Error(`Unknown unary operator: ${e.operator}`)}}static BUILTIN_PARAMS={sprite:["path","x","y","width","height","sx","sy","sw","sh","color"],text:["text","x","y","size","color"],rect:["x","y","width","height","color"],circle:["x","y","radius","color"],line:["x1","y1","x2","y2","color","width"],clear:["color"],min:["a","b"],max:["a","b"],clamp:["value","min","max"],lerp:["a","b","t"],distance:["x1","y1","x2","y2"],rect_overlap:["x1","y1","w1","h1","x2","y2","w2","h2"],randomInt:["min","max"],push:["arr","value"],insert:["arr","index","value"],remove:["arr","value"],extend:["arr","other"],count:["arr","value"],index:["arr","value"],contains:["arr","value"],slice:["arr","start","end"],join:["arr","separator"],array:["size"],music:["path","volume"],music_volume:["volume"],sound:["path","gain"],master_volume:["volume"],pressed:["action"],held:["action"],released:["action"],key_pressed:["key"],key_held:["key"],key_released:["key"],mouse_pressed:["button"],mouse_held:["button"],mouse_released:["button"],touch_x:["index"],touch_y:["index"],buffer_input:["action","duration"],check_buffer:["action"],peek_buffer:["action"],clear_buffer:["action"],buffer_time:["action"],deg:["radians"],rad:["degrees"],asin:["x"],acos:["x"],atan:["x"],sinh:["x"],cosh:["x"],tanh:["x"],log:["x"],log10:["x"],exp:["x"]};evaluateCall(e){let t=this.evaluate(e.callee),r=[],s=new Map;for(let a of e.arguments){let n=this.evaluate(a.value);a.name===null?r.push(n):s.set(a.name,n)}if(typeof t=="function"){let a=null;e.callee.type==="Identifier"&&(a=e.callee.name);let n=a?l.BUILTIN_PARAMS[a]:null,i=this.resolveArgs(r,s,n);return t(...i)}if(H(t))return this.callFunction(t,r,s);if(F(t)){let a=this.resolveArgs(r,s,t.fields);return this.callVariantConstructor(t,a)}throw new Error("Can only call functions or enum variant constructors")}resolveArgs(e,t,r){if(t.size===0)return e;if(!r)return[...e,...t.values()];let s=[...e];for(let[a,n]of t){let i=r.indexOf(a);if(i===-1)throw new Error(`Unknown keyword argument: ${a}`);for(;s.length<=i;)s.push(null);s[i]=n}return s}callFunction(e,t,r){let s=new g(e.closure);for(let n=0;n<e.parameters.length;n++)s.define(e.parameters[n],t[n]??null);for(let[n,i]of r){if(!e.parameters.includes(n))throw new Error(`Unknown keyword argument: ${n} for function ${e.name}`);s.define(n,i)}let a=this.currentEnv;this.currentEnv=s;try{this.executeBlock(e.body)}catch(n){if(n instanceof b)return this.currentEnv=a,n.value;throw n}return this.currentEnv=a,null}callVariantConstructor(e,t){let r=new Map;for(let s=0;s<e.fields.length;s++)r.set(e.fields[s],t[s]??null);return T(e.enumName,e.variantName,r)}evaluateMember(e){let t=this.evaluate(e.object),r=e.property.name;if(A(t))return t[r]??null;if(Array.isArray(t)&&r==="length")return t.length;throw new Error("Can only access properties on prototypes or arrays")}evaluateIndex(e){let t=this.evaluate(e.object),r=this.evaluate(e.index);if(Array.isArray(t)){let s=Number(r)|0;return s<0&&(s=t.length+s),t[s]??null}if(typeof t=="string"){let s=Number(r)|0;return s<0&&(s=t.length+s),t[s]??null}if(A(t))return t[String(r)]??null;throw new Error("Can only index into arrays, strings, or prototypes")}evaluateSlice(e){let t=this.evaluate(e.object),r=e.start?this.evaluate(e.start):null,s=e.end?this.evaluate(e.end):null,a=(n,i,o)=>{if(n===null)return o?i:0;let h=n|0;return h<0&&(h=i+h),Math.max(0,Math.min(i,h))};if(Array.isArray(t)){let n=a(r!==null?Number(r):null,t.length,!1),i=a(s!==null?Number(s):null,t.length,!0);return t.slice(n,i)}if(typeof t=="string"){let n=a(r!==null?Number(r):null,t.length,!1),i=a(s!==null?Number(s):null,t.length,!0);return t.slice(n,i)}throw new Error("Can only slice arrays or strings")}evaluateAssignment(e){let t=this.evaluate(e.right);if(e.left.type==="Identifier"){let r=e.left.name;this.currentEnv.set(r,t)}else if(e.left.type==="MemberExpression"){let r=e.left,s=this.evaluate(r.object),a=r.property.name;if(A(s))s[a]=t;else throw new Error("Can only set properties on prototypes")}else if(e.left.type==="IndexExpression"){let r=e.left,s=this.evaluate(r.object),a=this.evaluate(r.index);if(Array.isArray(s)){let n=Number(a)|0;s[n]=t}else if(A(s))s[String(a)]=t;else throw new Error("Can only index-assign to arrays or prototypes")}return t}isTruthy(e){return e===null?!1:typeof e=="boolean"?e:typeof e=="number"?e!==0:typeof e=="string"?e.length>0:!0}getEnvironment(){return this.currentEnv}reset(){this.stopGameLoop(),this.globalEnv=new g,this.currentEnv=this.globalEnv,this.drawBlock=null,this.updateBlock=null;for(let[e,t]of this.builtins)this.globalEnv.define(e,t)}};var N=class{canvas;ctx;width;height;sprites=new Map;constructor(e,t){this.width=t.width,this.height=t.height,this.canvas=e,this.ctx=null,e&&(e.width=this.width,e.height=this.height,this.ctx=e.getContext("2d"))}clear(e="#000000"){this.ctx&&(this.ctx.fillStyle=e,this.ctx.fillRect(0,0,this.width,this.height))}text(e,t,r,s=16,a="#ffffff",n=1){if(!this.ctx)return;let i=this.ctx.globalAlpha;this.ctx.globalAlpha=Math.max(0,Math.min(1,n)),this.ctx.fillStyle=a,this.ctx.font=`${s}px monospace`,this.ctx.fillText(e,t,r),this.ctx.globalAlpha=i}sprite(e,t,r,s=32,a=32,n=null,i=null,o=null,h=null,c="#ffffff",m=1){if(!this.ctx)return;let f=this.ctx.globalAlpha;if(this.ctx.globalAlpha=Math.max(0,Math.min(1,m)),!e){this.ctx.fillStyle=c,this.ctx.fillRect(t,r,s,a),this.ctx.globalAlpha=f;return}let p=this.sprites.get(e);if(!p){let d=new Image;p={image:d,loaded:!1},this.sprites.set(e,p),d.onload=()=>{p.loaded=!0},d.onerror=()=>{console.warn(`Failed to load sprite: ${e}`)},d.src=e}p.loaded?n!==null&&i!==null&&o!==null&&h!==null?this.ctx.drawImage(p.image,n,i,o,h,t,r,s,a):s&&a?this.ctx.drawImage(p.image,t,r,s,a):this.ctx.drawImage(p.image,t,r):(this.ctx.fillStyle=c,this.ctx.fillRect(t,r,s,a)),this.ctx.globalAlpha=f}rect(e,t,r,s,a,n=1){if(!this.ctx)return;let i=this.ctx.globalAlpha;this.ctx.globalAlpha=Math.max(0,Math.min(1,n)),this.ctx.fillStyle=a,this.ctx.fillRect(e,t,r,s),this.ctx.globalAlpha=i}strokeRect(e,t,r,s,a,n=1,i=1){if(!this.ctx)return;let o=this.ctx.globalAlpha;this.ctx.globalAlpha=Math.max(0,Math.min(1,i)),this.ctx.strokeStyle=a,this.ctx.lineWidth=n,this.ctx.strokeRect(e,t,r,s),this.ctx.globalAlpha=o}circle(e,t,r,s,a=1){if(!this.ctx)return;let n=this.ctx.globalAlpha;this.ctx.globalAlpha=Math.max(0,Math.min(1,a)),this.ctx.fillStyle=s,this.ctx.beginPath(),this.ctx.arc(e,t,r,0,Math.PI*2),this.ctx.fill(),this.ctx.globalAlpha=n}strokeCircle(e,t,r,s,a=1,n=1){if(!this.ctx)return;let i=this.ctx.globalAlpha;this.ctx.globalAlpha=Math.max(0,Math.min(1,n)),this.ctx.strokeStyle=s,this.ctx.lineWidth=a,this.ctx.beginPath(),this.ctx.arc(e,t,r,0,Math.PI*2),this.ctx.stroke(),this.ctx.globalAlpha=i}line(e,t,r,s,a,n=1,i=1){if(!this.ctx)return;let o=this.ctx.globalAlpha;this.ctx.globalAlpha=Math.max(0,Math.min(1,i)),this.ctx.strokeStyle=a,this.ctx.lineWidth=n,this.ctx.beginPath(),this.ctx.moveTo(e,t),this.ctx.lineTo(r,s),this.ctx.stroke(),this.ctx.globalAlpha=o}getContext(){return!this.canvas||!this.ctx?null:{canvas:this.canvas,ctx:this.ctx}}getDimensions(){return{width:this.width,height:this.height}}setFont(e){this.ctx&&(this.ctx.font=e)}preloadSprite(e){return new Promise((t,r)=>{let s=new Image,a={image:s,loaded:!1};this.sprites.set(e,a),s.onload=()=>{a.loaded=!0,t()},s.onerror=()=>{r(new Error(`Failed to load sprite: ${e}`))},s.src=e})}};var G=class{interpreter;renderer;constructor(e={}){this.renderer=new N(e.canvas??null,{width:e.width??800,height:e.height??600}),this.interpreter=new w(this.renderer)}run(e){let r=new v(e).process(),a=new R(r).tokenize(),i=new x(a).parse();this.interpreter.run(i)}processSource(e){return new v(e).process()}start(){this.interpreter.startGameLoop()}stop(){this.interpreter.stopGameLoop()}getRenderContext(){return this.renderer.getContext()}};export{y as AudioManager,N as CanvasRenderer,v as FallingProcessor,E as InputManager,w as Interpreter,R as Lexer,x as Parser,G as Ragelang,k as TokenType};
