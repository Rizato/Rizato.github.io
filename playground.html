---
layout: default
title: Playground
description: Try Ragelang in your browser - an interactive code editor and game canvas
permalink: /playground/
---
<div class="loading-overlay" id="loading">
  <div class="loading-spinner"></div>
  <div class="loading-text">Loading Ragelang...</div>
</div>

<div class="playground-main">
  <div class="playground-panel">
    <div class="panel-header">
      <div class="playground-tabs">
        <button class="playground-tab active" data-tab="source">Source</button>
        <button class="playground-tab" data-tab="processed">Processed</button>
      </div>
      <div class="btn-group">
        <button class="btn btn-secondary" id="clear-btn">Clear</button>
        <button class="btn btn-primary" id="run-btn">▶ Run</button>
      </div>
    </div>
    <div class="panel-subheader">
      <label for="example-select">Example:</label>
      <select id="example-select">
        <option value="custom">Custom</option>
      </select>
    </div>
    <div class="code-editor">
      <div class="line-numbers" id="source-line-numbers"></div>
      <div class="code-content">
        <textarea id="editor" placeholder="Write your Ragelang code here...

Remember: Characters must be supported by characters beneath them!
Use # to create the foundation." spellcheck="false"></textarea>
        <div id="processed" class="processed-view"></div>
      </div>
    </div>
  </div>
  
  <div class="playground-panel">
    <div class="panel-header">
      <span class="panel-title">Output</span>
      <button class="btn btn-secondary" id="stop-btn">⏹ Stop</button>
    </div>
    <div class="canvas-wrapper">
      <canvas id="game-canvas" width="600" height="400" tabindex="0"></canvas>
    </div>
    <div class="console-area">
      <div class="console-header">Console</div>
      <div id="console"></div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/ragelang/dist/ragelang.bundle.min.js"></script>
<!-- <script src="/assets/js/ragelang.bundle.js"></script> -->
<script>
  // Get Ragelang from the global (IIFE bundle)
  const { Ragelang, FallingProcessor } = window.RagelangLib;

  // Known example files in assets/rage
  // Since we can't list files from a static server, we maintain this list
  const EXAMPLE_FILES = [
    'animation',
    'bouncing-ball',
    'collision',
    'hello-world',
    'menu',
    'mouse',
    'particles',
    'pattern',
    'platformer',
    'rainbow',
    'starfield'
  ];

  // Cache for loaded examples
  const loadedExamples = new Map();

  // DOM Elements
  const editor = document.getElementById('editor');
  const processedView = document.getElementById('processed');
  const consoleEl = document.getElementById('console');
  const canvas = document.getElementById('game-canvas');
  const runBtn = document.getElementById('run-btn');
  const stopBtn = document.getElementById('stop-btn');
  const clearBtn = document.getElementById('clear-btn');
  const tabs = document.querySelectorAll('.playground-tab');
  const lineNumbers = document.getElementById('source-line-numbers');
  const exampleSelect = document.getElementById('example-select');
  const loadingOverlay = document.getElementById('loading');

  let ragelang = null;
  let currentTab = 'source';

  // Hide loading overlay once bundle is loaded
  loadingOverlay.classList.add('hidden');

  // Populate dropdown with available examples
  function populateExamples() {
    // Clear existing options except "custom"
    while (exampleSelect.children.length > 1) {
      exampleSelect.removeChild(exampleSelect.lastChild);
    }
    
    // Add all example files
    EXAMPLE_FILES.forEach(filename => {
      const option = document.createElement('option');
      option.value = filename;
      // Convert kebab-case to Title Case
      option.textContent = filename.split('-').map(word => 
        word.charAt(0).toUpperCase() + word.slice(1)
      ).join(' ');
      exampleSelect.appendChild(option);
    });
  }

  // Fetch example code from assets/rage
  async function loadExample(name) {
    if (name === 'custom') {
      return;
    }

    // Check cache first
    if (loadedExamples.has(name)) {
      editor.value = loadedExamples.get(name);
      updateLineNumbers(editor.value);
      stop();
      clearConsole();
      exampleSelect.value = name;
      return;
    }
    
    try {
      const response = await fetch(`/assets/rage/${name}.rage`);
      if (!response.ok) {
        throw new Error(`Failed to load ${name}.rage: ${response.statusText}`);
      }
      const code = await response.text();
      
      // Cache the loaded code
      loadedExamples.set(name, code);
      
      editor.value = code;
      updateLineNumbers(editor.value);
      stop();
      clearConsole();
      exampleSelect.value = name;
    } catch (error) {
      log(`Error loading example: ${error.message}`, 'error');
      console.error(error);
      // Switch back to custom on error
      exampleSelect.value = 'custom';
    }
  }

  function updateLineNumbers(text) {
    const lines = text.split('\n');
    lineNumbers.innerHTML = lines.map((_, i) => 
      `<span class="line-num">${i + 1}</span>`
    ).join('');
  }

  function log(message, type = 'info') {
    const line = document.createElement('div');
    line.className = `console-line ${type}`;
    line.textContent = message;
    consoleEl.appendChild(line);
    consoleEl.scrollTop = consoleEl.scrollHeight;
  }

  function clearConsole() {
    consoleEl.innerHTML = '';
  }

  // Override console.log to capture output
  const originalLog = console.log;
  console.log = function(...args) {
    originalLog.apply(console, args);
    log(args.join(' '));
  };

  function escapeHtml(str) {
    return str
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }

  function updateProcessedView() {
    try {
      const source = editor.value;
      const processor = new FallingProcessor(source);
      
      const sourceLines = source.split('\n');
      const processed = processor.process();
      
      if (!processed) {
        processedView.innerHTML = '<span style="color: var(--text-muted)">(empty - no foundation found)</span>';
        updateLineNumbers('');
        return;
      }

      const processedLines = processed.split('\n');
      const fallenPositions = new Set();
      
      for (let row = 0; row < processedLines.length; row++) {
        for (let col = 0; col < processedLines[row].length; col++) {
          const char = processedLines[row][col];
          if (char !== ' ') {
            const key = `${row},${col}`;
            const originalChar = sourceLines[row]?.[col];
            if (originalChar !== char) {
              fallenPositions.add(key);
            }
          }
        }
      }
      
      let html = '';
      for (let row = 0; row < processedLines.length; row++) {
        const line = processedLines[row];
        for (let col = 0; col < line.length; col++) {
          const char = line[col];
          const key = `${row},${col}`;
          if (fallenPositions.has(key) && char !== ' ') {
            html += `<span class="fallen-char">${escapeHtml(char)}</span>`;
          } else {
            html += escapeHtml(char);
          }
        }
        html += '\n';
      }
      
      processedView.innerHTML = html;
      updateLineNumbers(processed);
    } catch (e) {
      processedView.innerHTML = `<span style="color: var(--accent-coral)">Error: ${escapeHtml(e.message)}</span>`;
    }
  }

  function run() {
    stop();
    clearConsole();
    
    try {
      ragelang = new Ragelang({ canvas, width: 600, height: 400 });
      log('Running Ragelang program...', 'success');
      ragelang.run(editor.value);
      ragelang.start();
      updateProcessedView();
      // Focus the canvas so keyboard input goes to the game, not buttons
      canvas.focus();
    } catch (e) {
      log(`Error: ${e.message}`, 'error');
      console.error(e);
    }
  }

  function stop() {
    if (ragelang) {
      ragelang.stop();
      ragelang = null;
    }
  }

  // Event Listeners
  editor.addEventListener('scroll', () => {
    lineNumbers.scrollTop = editor.scrollTop;
  });

  editor.addEventListener('input', () => {
    if (currentTab === 'source') {
      updateLineNumbers(editor.value);
    }
    // Mark as custom when user edits
    // Check if current value matches any cached example
    let isExample = false;
    for (const [name, code] of loadedExamples.entries()) {
      if (editor.value === code) {
        isExample = true;
        exampleSelect.value = name;
        break;
      }
    }
    if (!isExample) {
      exampleSelect.value = 'custom';
    }
  });

  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      tabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      
      currentTab = tab.dataset.tab;
      if (currentTab === 'source') {
        editor.style.display = 'block';
        processedView.classList.remove('visible');
        updateLineNumbers(editor.value);
      } else {
        editor.style.display = 'none';
        processedView.classList.add('visible');
        updateProcessedView();
      }
    });
  });

  exampleSelect.addEventListener('change', async (e) => {
    const value = e.target.value;
    if (value === 'custom') {
      // Clear editor for custom code
      editor.value = '';
      stop();
      clearConsole();
      updateLineNumbers('');
    } else {
      await loadExample(value);
    }
  });

  runBtn.addEventListener('click', () => {
    run();
    runBtn.blur(); // Remove focus so spacebar doesn't re-trigger
  });
  stopBtn.addEventListener('click', () => {
    stop();
    stopBtn.blur();
  });
  clearBtn.addEventListener('click', () => {
    editor.value = '';
    stop();
    clearConsole();
    updateLineNumbers('');
    exampleSelect.value = 'custom';
    clearBtn.blur();
  });

  // Handle keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    // Ctrl/Cmd + Enter to run
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
      e.preventDefault();
      run();
    }
  });

  // Initialize: populate dropdown and load initial example
  populateExamples();
  loadExample('bouncing-ball');
</script>
